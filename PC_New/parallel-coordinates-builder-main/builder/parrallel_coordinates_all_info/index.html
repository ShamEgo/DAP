<!DOCTYPE html>
<html lang="en"><head>
  <meta http-equiv="Content-type" content="text/html; charset=UTF-8">
  <title>parrallel_coordinates_all_info</title>
  
  <!-- libs -->
  <!-- pixijs -->
  <script type="text/javascript" src="files/libs/pixi.js/v7.2.4/pixi.min.js"></script>

  <!-- d3 -->
  <script type="text/javascript" src="files/libs/d3.v7.min.js"></script>

  <!-- d3 curve interpolation helper -->
  <script src="files/d3-interpolate-curve.min.js"></script>

  <!-- jquery -->
  <script type="text/javascript" src="files/libs/jquery-3.7.1.min.js"></script>

  <!-- parallel coordinates implementation -->
  <script type="text/javascript" src="files/parallel-coordinates.js"></script>

  <!-- underscore & backbone -->
  <script type="text/javascript" src="files/libs/underscore/1.13.7/underscore-umd-min.js"></script>
  <script type="text/javascript" src="files/libs/backbone/1.6.0/backbone-min.js"></script>

  <!-- jquery-ui -->
  <script src="files/libs/jqueryui/1.14.1/jquery-ui.min.js"></script>
  
  <!-- backbone 'filter' sample -->
  <script type="text/javascript" src="files/filter.js"></script>
  
  <!-- SlickGrid -->
  <link rel="stylesheet" href="files/libs/slickgrid/5.15.2/css/slick.grid.css" type="text/css" media="screen" charset="utf-8">
  <script src="files/libs/Sortable/1.15.6/Sortable.min.js"></script>
  <script src="files/libs/slickgrid/5.15.2/slick.core.min.js"></script>
  <script src="files/libs/slickgrid/5.15.2/slick.interactions.min.js"></script>
  <script src="files/libs/slickgrid/5.15.2/slick.grid.min.js"></script>
  <script src="files/libs/slickgrid/5.15.2/controls/slick.pager.min.js"></script>
  <script src="files/libs/slickgrid/5.15.2/slick.dataview.min.js"></script>
  
  <!-- grid example -->
  <script src="files/grid.js"></script>

  <!-- d3 pie graph -->
  <script src="files/pie.js"></script>

  <!-- options functions -->
  <script src="files/options.js"></script>

  <!-- data to visualise -->
  <script src="files/data.js"></script>

  <!-- css styling -->
  <link rel="stylesheet" href="files/style.css" type="text/css" charset="utf-8">

  <!-- Leaflet (for map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    /* Two panes across: left = map, right = content */
    .layout {
      display: grid;
      grid-template-columns: 40vw 1fr;  /* map | content */
      width: 100vw; 
      min-height: 100vh;
    }
    /* Map */
    .map-wrapper { height: 100%; }
    #map { width: 100%; height: 100%; }

    /* Right content */
    #main { padding: 0 8px; display: grid; grid-template-rows: auto 1fr; min-height: 100%; }

    /* Parallel + rows side-by-side; rows pane slightly wider */
    #container {
      display: grid;
      grid-template-columns: 1fr 1.1fr;
      gap: 12px;
      align-items: stretch;
      /* height set by JS to fill viewport under widgets */
    }

    /* Ensure children can grow/shrink properly inside grid cells */
    .parallel-container, .grid-container, #parallel, #myGrid {
      width: 100%;
      height: 100%;
      min-height: 0;
    }

    /* Hide Leaflet attribution if any */
    .leaflet-control-attribution { display: none !important; }
  </style>
</head>

<body>
<div id="nav">
  <h1>parrallel_coordinates_all_info - Parallel Coordinates</h1>
  <div class="widget right toggle">
	  <input type="range" min="0" max="1" value="0.2" step="0.01" name="power" list="powers" id="line_opacity">
   <br>
	  Opacity: <span id="opacity_level">20%</span>
	</div>
  <div><a href="#" id="force_tb" class="right toggle">Force Top/Bottom</a></div>
  <div><a href="#" id="inverted" class="right toggle">Dark</a></div>
  <div><a href="#" id="no_ticks" class="right toggle">Hide Ticks</a></div>
  <p class="intro left clear">
    parrallel_coordinates_all_info
  </p>
</div>

<!-- layout wrapper with a map on the left -->
<div class="layout">
  <div class="map-wrapper">
    <div id="map"></div>
  </div>

  <div id="main">
    <div class="widgets">
      <div id="totals" class="widget right">Total Selected<br></div>
      <div id="pie" class="widget right">Group Breakdown<br></div>
      <a href="#" id="export_selected" class="button green filter_control">Export</a>
      <a href="#" id="remove_selected" class="button red filter_control">Remove</a>
      <a href="#" id="keep_selected" class="button green filter_control">Keep</a>
      <div id="pager" class="info"></div>
      <div id="legend"></div>
    </div>

    <div id="container">
      <div class="parallel-container">
        <div id="parallel"></div>
      </div>
      <div class="grid-container">
        <div id="myGrid"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(function() {
  if (!window.dataJSON || !dataJSON.length) {
    console.warn('dataJSON is empty or not loaded. Check files/data.js');
  }

  var dimensions = new Filter();
  var highlighter = new Selector();
  dimensions.set({data: dataJSON });

  var columns = _(dataJSON[0]).keys();
  var groups  = ["ACT", "NSW", "NT", "QLD", "SA", "TAS", "VIC", "WA"];;
  var colors  = {"ACT": "#75513b", "NSW": "#ed2b9a", "NT": "#971210", "QLD": "#f21705", "SA": "#748e19", "TAS": "#9f4dd0", "VIC": "#30c129", "WA": "#9e0a01"};;

  /* ===== Force Paired 12 palette for all groups ===== */
  (function applyPaired12(){
    var palette = ["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99",
                   "#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a",
                   "#ffff99","#b15928"];
    var remap = {};
    for (var i=0; i<groups.length; i++) remap[groups[i]] = palette[i % palette.length];
    colors = remap; // override injected {"ACT": "#75513b", "NSW": "#ed2b9a", "NT": "#971210", "QLD": "#f21705", "SA": "#748e19", "TAS": "#9f4dd0", "VIC": "#30c129", "WA": "#9e0a01"};
  })();
  /* ================================================ */

  _(groups).each(function(group) {
    $('#legend').append(
      "<div class='item'><div class='color' style='background:" + colors[group] + "'></div><div class='key'>" + group + "</div></div>"
    );
  });

  var pc   = parallel(dimensions, colors);
  var pie  = piegroups(dataJSON, groups, colors, 'State');
  var totals = pietotals(['in', 'out'], [_(dataJSON).size(), 0]);

  var slicky = new grid({
    model: dimensions,
    selector: highlighter,
    columns: columns,
    forceFitColumns: false
  });

  slicky.update();
  pc.render();

  const gridContainer     = document.querySelector('.grid-container');
  const parallelContainer = document.querySelector('.parallel-container');

  // Keep grid canvas sized to its container
  const gridResizeObserver = new ResizeObserver(() => {
    const gridEl = document.getElementById('myGrid');
    gridEl.style.width  = gridContainer.clientWidth + 'px';
    gridEl.style.height = gridContainer.clientHeight + 'px';
    if (slicky.grid) slicky.grid.resizeCanvas();
  });
  gridResizeObserver.observe(gridContainer);

  // Keep grid height in sync with parallel container height
  const observer = new MutationObserver(() => {
    const gridEl = document.getElementById('myGrid');
    gridEl.style.width  = gridContainer.clientWidth + 'px';
    gridEl.style.height = parallelContainer.clientHeight + 'px';
    if (slicky.grid) slicky.grid.resizeCanvas();
  });
  observer.observe(document.getElementById('myGrid'), {
    attributes: true,
    attributeOldValue: true,
    attributeFilter: ["class", "style", "float"],
  });

  /* =================== MAP INTEGRATION (Leaflet) =================== */
  // guess lat/lon column names
  var LAT_FIELD, LON_FIELD;
  (function guessLatLon(){
    var keys = _.keys(dataJSON[0] || {});
    var latKeys = ["Latitude","LAT","Lat","lat"];
    var lonKeys = ["Longitude","LONGITUDE","Long","Lng","lon","lng"];
    LAT_FIELD = _.find(latKeys, function(k){ return _.contains(keys, k); }) || "Latitude";
    LON_FIELD = _.find(lonKeys, function(k){ return _.contains(keys, k); }) || "Longitude";
  })();

  // dark basemap, fixed view, no attribution
  var map = L.map('map', { zoomControl: true, preferCanvas: true, attributionControl: false });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
  map.setView([-25.2744, 133.7751], 4); // AU default; fixed (no auto-pan/zoom)

  var markerLayer = L.layerGroup().addTo(map);

  function parseNum(x){ var v = Number(x); return isFinite(v) ? v : null; }
  function validLatLon(lat, lon){
    return lat !== null && lon !== null && lat <= 90 && lat >= -90 && lon <= 180 && lon >= -180;
  }

  function updateMap(rows){
    markerLayer.clearLayers();
    if (!rows || !rows.length) return;

    for (var i=0; i<rows.length; i++){
      var r = rows[i];
      var lat = parseNum(r[LAT_FIELD]);
      var lon = parseNum(r[LON_FIELD]);
      if (!validLatLon(lat, lon)) continue;

      var grp = r['State'];                 // colour by your group field
      var color = colors[grp] || '#58a6ff';

      L.circleMarker([lat, lon], {
        radius: 6,
        color: color, weight: 2,
        fillColor: color, fillOpacity: 0.55
      })
      .bindPopup(
        '<div style="min-width:200px">' +
          '<div><b>AMSAssetRef:</b> ' + _.escape(String(r.AMSAssetRef || '')) + '</div>' +
          '<div><b>State:</b> ' + _.escape(String(r.State || '')) + '</div>' +
          '<div><b>StructureClassCode:</b> ' + _.escape(String(r.StructureClassCode || '')) + '</div>' +
          '<div><b>CorrosionRegionType:</b> ' + _.escape(String(r.CorrosionRegionType || '')) + '</div>' +
        '</div>',
        { autoPan: false }   // do not move the map for popups
      )
      .addTo(markerLayer);
    }
    // no fitBounds / setView here → no auto panning/zooming
  }

  // Debounce heavy redraws (brushing fires rapidly)
  var updateMapDebounced = _.debounce(updateMap, 120);
  // Initial map draw
  updateMap(dimensions.get('filtered') || dimensions.get('data') || []);
  /* ================= END MAP INTEGRATION ================= */

  // React to brushing/filtering and selection
  dimensions.bind('change:filtered', function() {
    var data = dimensions.get('data');
    var filtered = dimensions.get('filtered');
    var data_size = _(data).size();
    var filtered_size = _(filtered).size();
    pie.update(filtered);
    totals.update([filtered_size, data_size - filtered_size]);

    // Debounced map redraw (keeps fixed view)
    updateMapDebounced(filtered);

    var opacity = _([2/Math.pow(filtered_size,0.37), 100]).min();
    $('#line_opacity').val(opacity).change();
  });
  
  highlighter.bind('change:selected', function() {
    var highlighted = this.get('selected');
    pc.highlight(highlighted);
    // Keep full filtered set on the map (don’t focus on one)
    updateMapDebounced(dimensions.get('filtered') || []);
  });

  // Buttons
  $('#remove_selected').on("click", function() {
    dimensions.outliers();
    pc.update(dimensions.get('data'));
    pc.render();
    dimensions.trigger('change:filtered');
    return false;
  });
  
  $('#keep_selected').on("click", function() {
    dimensions.inliers();
    pc.update(dimensions.get('data'));
    pc.render();
    dimensions.trigger('change:filtered');
    return false;
  });
  
  $('#export_selected').on("click", function() {
    var data = dimensions.get('filtered');
    var keys = _.keys(data[0]);
    var csv = _(keys).map(function(d) { return '"' + addslashes(d) + '"'; }).join(",");
    _(data).each(function(row) {
      csv += "\n";
      csv += _(keys).map(function(k) {
        var val = row[k];
        if (_.isString(val)) return '"' + addslashes(val) + '"';
        if (_.isNumber(val)) return val;
        if (_.isNull(val))   return "";
      }).join(",");
    });
    var uriContent = "data:application/octet-stream," + encodeURIComponent(csv);
    var myWindow = window.open(uriContent, "Export CSV");
    myWindow.focus();
    return false;
  });

  $('#line_opacity').on("change", function() {
    var val = $(this).val();
    pc.opacity = val;
    $('#opacity_level').html((Math.round(val*10000)/100) + "%");
    if (!pc.brushing) pc.render();
  });

  // === Explicit heights so #parallel and #myGrid fill the window ===
  function sizeVizToViewport(){
    var headerH  = $('#nav').outerHeight(true) || 0;
    var available = window.innerHeight - headerH;

    // Left map column
    $('.map-wrapper').css('height', available + 'px');
    $('#map').css('height', available + 'px');

    // Right content: widgets at top, viz row below
    var widgetsH = $('.widgets').outerHeight(true) || 0;
    var vizH = Math.max(160, available - widgetsH - 8); // leave a tiny gap
    $('#container').css('height', vizH + 'px');
    $('.parallel-container').css('height', vizH + 'px');
    $('.grid-container').css('height', vizH + 'px');

    pc.render();
    if (slicky && slicky.grid) slicky.grid.resizeCanvas();
  }
  sizeVizToViewport();
  $(window).on('resize', _.debounce(sizeVizToViewport, 120));

  $("#parallel").resizable({ handles: 's', resize: function () { return false; } });

  function addslashes(str){
    return (str+'').replace(/\"/g, "\"\"").replace(/\0/g, "\\0");
  }
});
</script>
</body></html>
