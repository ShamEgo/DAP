<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-type" content="text/html; charset=UTF-8">
  <title>parrallel_coordinates_all_info</title>

  <!-- Original libs -->
  <script type="text/javascript" src="files/d3.js"></script>
  <script type="text/javascript" src="files/d3_002.js"></script>
  <script type="text/javascript" src="files/d3_003.js"></script>
  <script type="text/javascript" src="files/parallel-coordinates.js"></script>

  <script type="text/javascript" src="files/jquery_002.js"></script>
  <script type="text/javascript" src="files/underscore.js"></script>
  <script type="text/javascript" src="files/backbone.js"></script>

  <script src="files/jquery-ui-1.js"></script>
  <script type="text/javascript" src="files/filter.js"></script>

  <!-- SlickGrid -->
  <link rel="stylesheet" href="files/slick.css" type="text/css" media="screen" charset="utf-8">
  <script src="files/jquery.js"></script>
  <script src="files/slick_003.js"></script>
  <script src="files/slick_004.js"></script>
  <script src="files/slick_002.js"></script>
  <script src="files/slick.js"></script>
  <script src="files/grid.js"></script>
  <script src="files/pie.js"></script>
  <script src="files/options.js"></script>
  <script src="files/data.js"></script>
  <link rel="stylesheet" href="files/style.css" type="text/css" charset="utf-8">

  <!-- Leaflet (dark map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Two-pane layout: fixed map left, content right -->
  <style>
    html, body { height: 100%; margin: 0; }
    .layout {
      display: grid;
      grid-template-columns: 40vw 1fr; /* left 40% of viewport */
      grid-template-rows: 100vh;       /* full window height */
      width: 100vw; height: 100vh; overflow: hidden;
    }
    #left { height: 100vh; }
    #map  { width: 100%; height: 100%; } /* fills left pane; no JS resize */

    /* Right pane scrolls independently */
    #right { height: 100vh; overflow: auto; padding: 0 8px; }

    /* Make the parallel canvas reasonably tall by default */
    #parallel { min-height: 420px; }

    /* (kept from your inline SlickGrid style) */
    .slickgrid_108761 .slick-header-column { left: 1000px; }
    .slickgrid_108761 .slick-top-panel { height:25px; }
    .slickgrid_108761 .slick-headerrow-columns { height:25px; }
    .slickgrid_108761 .slick-cell { height:22px; }
    .slickgrid_108761 .slick-row { width:1620px; height:25px; }
    .slickgrid_108761 .lr { float:none; position:absolute; }
    .slickgrid_108761 .l0 { left: 0px; }
    .slickgrid_108761 .r0 { right: 1300px; }
    .slickgrid_108761 .l1 { left: 320px; }
    .slickgrid_108761 .r1 { right: 1120px; }
    .slickgrid_108761 .l2 { left: 500px; }
    .slickgrid_108761 .r2 { right: 1040px; }
    .slickgrid_108761 .l3 { left: 580px; }
    .slickgrid_108761 .r3 { right: 960px; }
    .slickgrid_108761 .l4 { left: 660px; }
    .slickgrid_108761 .r4 { right: 880px; }
    .slickgrid_108761 .l5 { left: 740px; }
    .slickgrid_108761 .r5 { right: 800px; }
    .slickgrid_108761 .l6 { left: 820px; }
    .slickgrid_108761 .r6 { right: 720px; }
    .slickgrid_108761 .l7 { left: 900px; }
    .slickgrid_108761 .r7 { right: 640px; }
    .slickgrid_108761 .l8 { left: 980px; }
    .slickgrid_108761 .r8 { right: 560px; }
    .slickgrid_108761 .l9 { left: 1060px; }
    .slickgrid_108761 .r9 { right: 480px; }
    .slickgrid_108761 .l10 { left: 1140px; }
    .slickgrid_108761 .r10 { right: 400px; }
    .slickgrid_108761 .l11 { left: 1220px; }
    .slickgrid_108761 .r11 { right: 320px; }
    .slickgrid_108761 .l12 { left: 1300px; }
    .slickgrid_108761 .r12 { right: 240px; }
    .slickgrid_108761 .l13 { left: 1380px; }
    .slickgrid_108761 .r13 { right: 160px; }
    .slickgrid_108761 .l14 { left: 1460px; }
    .slickgrid_108761 .r14 { right: 80px; }
    .slickgrid_108761 .l15 { left: 1540px; }
    .slickgrid_108761 .r15 { right: 0px; }
  </style>
</head>

<body>
  <div class="layout">
    <aside id="left">
      <div id="map"></div>
    </aside>

    <section id="right">
      <div id="main">
        <div class="widgets">
          <div id="totals" class="widget right">Total Selected<br><svg height="80" width="100"></svg></div>
          <div id="pie" class="widget right">Group Breakdown<br><svg height="80" width="100"></svg></div>
          <a href="#" id="export_selected" class="button green filter_control">Export</a>
          <a href="#" id="remove_selected" class="button red filter_control">Remove</a>
          <a href="#" id="keep_selected" class="button green filter_control">Keep</a>
          <div id="pager" class="info"></div>
          <div id="legend"></div>
        </div>

        <div id="parallel"></div>
        <div id="myGrid"></div>
      </div>
    </section>
  </div>

  <script type="text/javascript">
  $(function() {

    var dimensions = new Filter();
    var highlighter = new Selector();

    dimensions.set({data: dataJSON});

    var columns = _(dataJSON[0]).keys();
    var axes = columns;

    var groups = ["ACT", "NSW", "NT", "QLD", "SA", "TAS", "VIC", "WA"];;
    var colors = {"ACT": "#9f1174", "NSW": "#474168", "NT": "#0b9913", "QLD": "#1a90ab", "SA": "#6338e6", "TAS": "#acc7d4", "VIC": "#ac9719", "WA": "#76b223"};;

    _(groups).each(function(group) {
      $('#legend').append("<div class='item'><div class='color' style='background: " + colors[group] + "';></div><div class='key'>" + group + "</div></div>");
    });

    var pc = parallel(dimensions, colors);

    // ---------- MAP INTEGRATION (Leaflet) â€” debounced only ----------
    var LAT_FIELD, LON_FIELD;
    (function guessLatLon(){
      var keys = _.keys(dataJSON[0] || {});
      var latKeys = ["Latitude","LAT","Lat","lat"];
      var lonKeys = ["Longitude","LONGITUDE","Long","Lng","lon","lng"];
      LAT_FIELD = _.find(latKeys, function(k){ return _.contains(keys, k); }) || "Latitude";
      LON_FIELD = _.find(lonKeys, function(k){ return _.contains(keys, k); }) || "Longitude";
    })();

    // prefer Canvas for speed; dark tiles
    var map = L.map('map', { zoomControl: true, preferCanvas: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CartoDB'
    }).addTo(map);

    var markerLayer = L.layerGroup().addTo(map);

    function parseNum(x){ var v = Number(x); return isFinite(v) ? v : null; }
    function validLatLon(lat, lon){
      return lat !== null && lon !== null && lat <= 90 && lat >= -90 && lon <= 180 && lon >= -180;
    }

    function updateMap(rows){
      markerLayer.clearLayers();

      if (!rows || !rows.length){
        map.setView([-25.2744, 133.7751], 4); // AU default
        return;
      }

      var bounds = [];
      for (var i=0; i<rows.length; i++){
        var r = rows[i];
        var lat = parseNum(r[LAT_FIELD]);
        var lon = parseNum(r[LON_FIELD]);
        if (!validLatLon(lat, lon)) continue;

        var grp = r['State'];
        var color = colors[grp] || '#58a6ff';

        L.circleMarker([lat, lon], {
          radius: 6,
          color: color, weight: 2,
          fillColor: color, fillOpacity: 0.55
        })
        // comment out popup for maximum speed on huge sets
        .bindPopup(
          '<div style="min-width:200px">' +
          '<div><b>AMSAssetRef:</b> ' + _.escape(String(r.AMSAssetRef || '')) + '</div>' +
          '<div><b>State:</b> ' + _.escape(String(r.State || '')) + '</div>' +
          '<div><b>StructureClassCode:</b> ' + _.escape(String(r.StructureClassCode || '')) + '</div>' +
          '<div><b>CorrosionRegionType:</b> ' + _.escape(String(r.CorrosionRegionType || '')) + '</div>' +
          '</div>'
        )
        .addTo(markerLayer);

        bounds.push([lat, lon]);
      }

      if (bounds.length) map.fitBounds(bounds, { padding: [20,20] });
      else map.setView([-25.2744, 133.7751], 4);
    }

    // Debounce heavy redraws (brushing fires rapidly)
    var updateMapDebounced = _.debounce(updateMap, 120);

    // Initial draw
    updateMap(dimensions.get('filtered') || dimensions.get('data') || []);
    // ---------- END MAP INTEGRATION ----------

    var pie = piegroups(dataJSON, groups, colors, 'State');
    var totals = pietotals(
      ['in', 'out'],
      [_(dataJSON).size(), 0]
    );

    var slicky = new grid({
      model: dimensions,
      selector: highlighter,
      width: $('body').width(),
      columns: columns
    });

    // vertical full screen (width constrained by right pane)
    var parallel_height = $(window).height() - 64 - 12 - 120 - 320;
    if (parallel_height < 120) parallel_height = 120; // min height
    $('#parallel').css({
      height: parallel_height + 'px',
      width: '100%'
    });

    slicky.update();
    pc.render();

    // === Hook existing events to debounced map updates ===
    dimensions.bind('change:filtered', function() {
      var data = dimensions.get('data');
      var filtered = dimensions.get('filtered');
      var data_size = _(data).size();
      var filtered_size = _(filtered).size();
      pie.update(filtered);
      totals.update([filtered_size, data_size - filtered_size]);

      // Debounced map redraw
      updateMapDebounced(filtered);

      var opacity = _([2/Math.pow(filtered_size,0.37), 100]).min();
      $('#line_opacity').val(opacity).change();
    });

    highlighter.bind('change:selected', function() {
      var highlighted = this.get('selected');
      pc.highlight(highlighted);

      // Show selected point on map, else all filtered
      var rows = dimensions.get('filtered') || [];
      if (highlighted == null || highlighted === undefined || !rows[highlighted]) {
        updateMapDebounced(rows);
      } else {
        updateMapDebounced([rows[highlighted]]);
      }
    });

    $('#remove_selected').click(function() {
      dimensions.outliers();
      pc.update(dimensions.get('data'));
      pc.render();
      dimensions.trigger('change:filtered');
      return false;
    });

    $('#keep_selected').click(function() {
      dimensions.inliers();
      pc.update(dimensions.get('data'));
      pc.render();
      dimensions.trigger('change:filtered');
      return false;
    });

    $('#export_selected').click(function() {
      var data = dimensions.get('filtered');
      var keys = _.keys(data[0]);
      var csv = _(keys).map(function(d) { return '"' + addslashes(d) + '"'; }).join(",");
      _(data).each(function(row) {
        csv += "\n";
        csv += _(keys).map(function(k) {
          var val = row[k];
          if (_.isString(val)) return '"' + addslashes(val) + '"';
          if (_.isNumber(val)) return val;
          if (_.isNull(val)) return "";
        }).join(",");
      });
      var uriContent = "data:application/octet-stream," + encodeURIComponent(csv);
      var myWindow = window.open(uriContent, "Nutrient CSV");
      myWindow.focus();
      return false;
    });

    $('#line_opacity').change(function() {
      var val = $(this).val();
      $('#parallel .foreground path').css('stroke-opacity', val.toString());
      $('#opacity_level').html((Math.round(val*10000)/100) + "%");
    });

    // Keep one resize handler for #parallel (no map resizing)
    $('#parallel').resize(function() {
      pc.render();
      var val = $('#line_opacity').val();
      $('#parallel .foreground path').css('stroke-opacity', val.toString());
    });

    $('#parallel').resizable({ handles: 's', resize: function () { return false; } });
    $('#myGrid').resizable({ handles: 's' });

    function addslashes( str ) {
      return (str+'')
        .replace(/\"/g, "\"\"")
        .replace(/\0/g, "\\0");
    }

  });
  </script>
</body>
</html>
